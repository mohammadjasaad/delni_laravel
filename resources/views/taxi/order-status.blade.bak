<x-main-layout title="ğŸš– Ø­Ø§Ù„Ø© Ø·Ù„Ø¨ Delni Taxi">
    {{-- ğŸ”” Ø¨Ø§Ù†Ø± Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª --}}
    <div id="notifBanner" class="w-full text-center py-2 font-semibold text-white hidden"></div>

    {{-- ğŸš¦ Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø© --}}
    <div id="statusBar" class="w-full text-center py-3 font-bold text-white transition-colors duration-500">
        ğŸš¦ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©...
    </div>

    @if(session('success'))
        <div class="bg-green-100 text-green-800 p-3 rounded mb-4 text-center max-w-xl mx-auto">
            {{ session('success') }}
        </div>
    @endif

    {{-- â­ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø³Ø§Ø¦Ù‚ --}}
    <div class="bg-white p-6 rounded shadow max-w-xl mx-auto mt-8">
        <h2 class="text-xl font-bold text-gray-800 text-center mb-4">â­ Ù‚ÙŠÙ‘Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚</h2>
        <form method="POST" action="{{ route('submit.rating') }}">
            @csrf
            <input type="hidden" name="driver_name" value="{{ $driver->name }}">
            <div class="mb-4 text-right">
                <label for="rating" class="block text-gray-700 font-semibold mb-1">Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:</label>
                <select name="rating" id="rating" class="w-full border rounded px-3 py-2">
                    <option value="">Ø§Ø®ØªØ± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</option>
                    <option value="5">â­â­â­â­â­ Ù…Ù…ØªØ§Ø²</option>
                    <option value="4">â­â­â­â­ Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§</option>
                    <option value="3">â­â­â­ Ø¬ÙŠØ¯</option>
                    <option value="2">â­â­ Ù…Ù‚Ø¨ÙˆÙ„</option>
                    <option value="1">â­ Ø¶Ø¹ÙŠÙ</option>
                </select>
            </div>
            <div class="mb-4 text-right">
                <label for="comment" class="block text-gray-700 font-semibold mb-1">Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</label>
                <textarea name="comment" id="comment" rows="3" class="w-full border rounded px-3 py-2"></textarea>
            </div>
            <div class="text-center">
                <button type="submit" class="bg-yellow-500 text-white px-5 py-2 rounded hover:bg-yellow-600 transition">
                    Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
                </button>
            </div>
        </form>
    </div>

    {{-- ğŸš• ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ --}}
    <div class="max-w-2xl mx-auto px-4 py-10 text-center">
        <h1 class="text-3xl font-bold text-yellow-600 mb-2">ğŸš– Ø·Ù„Ø¨Ùƒ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</h1>
        <div class="text-sm text-gray-500 mb-4">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: <span id="lastUpdate">Ø§Ù„Ø¢Ù†</span></div>

        <p class="text-gray-700 mb-6" id="statusText">
            @if ($order->status === 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°')
                ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ! Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ø£Ù‚Ø±Ø¨ ÙÙŠ Ø·Ø±ÙŠÙ‚Ù‡ Ø¥Ù„ÙŠÙƒ.
            @elseif ($order->status === 'Ø¨Ø¯Ø£Øª Ø§Ù„Ø±Ø­Ù„Ø©')
                ğŸš– Ø§Ù„Ø±Ø­Ù„Ø© Ø¨Ø¯Ø£Øª! Ø§Ø³ØªÙ…ØªØ¹ Ø¨Ù…Ø´ÙˆØ§Ø±Ùƒ.
            @elseif ($order->status === 'Ù…Ù†ØªÙ‡ÙŠ')
                âœ… Ø§Ù„Ø±Ø­Ù„Ø© Ù…Ù†ØªÙ‡ÙŠØ©.
            @else
                ğŸš§ Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨: {{ $order->status }}
            @endif
        </p>

        {{-- ğŸ—ºï¸ Ø®Ø±ÙŠØ·Ø© Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø±Ø§ÙƒØ¨ ÙÙ‚Ø· --}}
        <h3 class="text-xl font-bold text-gray-700 mt-10 mb-2">ğŸ—ºï¸ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø±Ø§ÙƒØ¨ (Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚)</h3>
        <div id="pickup-map" class="w-full h-[300px] rounded shadow border mb-6"></div>

        {{-- ğŸ‘¨â€âœˆï¸ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚ --}}
        <div class="bg-white shadow-md rounded-lg p-6 mb-6">
            <h3 class="text-xl font-semibold text-yellow-600 mb-4 flex items-center gap-2">ğŸ‘¨â€âœˆï¸ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-gray-700 text-right">
                <div><span class="font-bold">ğŸ‘¨â€âœˆï¸ Ø§Ù„Ø§Ø³Ù…:</span> <span id="dName">{{ $driver->name }}</span></div>
                <div><span class="font-bold">ğŸš— Ø§Ù„Ø³ÙŠØ§Ø±Ø©:</span> <span id="dCar">{{ $driver->car_number }}</span></div>
                <div>
                    <span class="font-bold">ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</span>
                    <a id="dPhone" href="tel:{{ $driver->phone ?? '' }}">{{ $driver->phone ?? 'ØºÙŠØ± Ù…ØªÙˆÙØ±' }}</a>
                </div>
                <div><span class="font-bold">â±ï¸ Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹:</span> <span id="eta" class="text-blue-600 font-semibold">Ø¬Ø§Ø±Ù Ø§Ù„Ø­Ø³Ø§Ø¨...</span></div>
                <div><span class="font-bold">ğŸš¦ Ø§Ù„Ø­Ø§Ù„Ø©:</span> <span id="dStatus">{{ $driver->status }}</span></div>
            </div>

            {{-- ğŸ”” ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØµÙØ­ --}}
            <div class="mt-4 text-right">
                <label class="inline-flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="notifToggle" class="h-4 w-4">
                    <span class="text-sm text-gray-700">ØªÙØ¹ÙŠÙ„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØµÙØ­ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø­Ù„Ø©</span>
                </label>
                <div class="text-xs text-gray-500 mt-1">
                    Ø³ØªØµÙ„Ùƒ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¹Ù†Ø¯ ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø£Ùˆ ØªØºÙŠÙ‘Ø± Ø§Ù„Ø­Ø§Ù„Ø©.
                </div>
            </div>
        </div>

        {{-- ğŸ“ Ø²Ø± Ø§Ù„Ø§ØªØµØ§Ù„ --}}
        <div class="mb-4">
            <button id="contactDriverBtn" class="bg-blue-500 text-white px-6 py-2 rounded-full hover:bg-blue-600 transition">
                ğŸ“ ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚
            </button>
        </div>

        {{-- ğŸ—ºï¸ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„ÙƒØ¨ÙŠØ±Ø© --}}
        <div id="map" class="w-full h-[500px] rounded-lg shadow mb-6"></div>

        {{-- ğŸ’¬ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© --}}
        <div class="max-w-xl mx-auto bg-white shadow rounded-lg p-5 mt-10">
            <h2 class="text-xl font-bold text-yellow-600 mb-4 text-center">ğŸ’¬ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚</h2>
            <div id="chatBox" class="h-64 overflow-y-auto border border-gray-300 p-4 rounded-lg bg-gray-50 space-y-2 text-sm text-right"></div>
            <form id="chatForm" class="mt-4 flex gap-3">
                @csrf
                <input type="hidden" name="order_id" value="{{ $order->id }}">
                <input type="hidden" name="sender" value="user">
                <input type="text" name="message" placeholder="âœï¸ Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-500" required>
                <button type="submit" class="bg-yellow-500 hover:bg-yellow-600 text-white px-5 py-2 rounded-lg transition">Ø¥Ø±Ø³Ø§Ù„</button>
            </form>
        </div>

        {{-- ğŸ”˜ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… --}}
        <div class="text-center mt-8 space-y-4">
            <div class="flex flex-col sm:flex-row justify-center items-center gap-4 mt-6">
                @if ($order->status === 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°')
                    <form action="{{ route('taxi.order.start', $order->id) }}" method="POST" onsubmit="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©ØŸ')">
                        @csrf
                        <button type="submit" class="bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-3 rounded-lg shadow transition-all duration-200">ğŸš¦ Ø¨Ø¯Ø£ Ø§Ù„Ø±Ø­Ù„Ø©</button>
                    </form>
                @endif
                <button onclick="cancelOrder()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg shadow transition-all duration-200">âŒ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨</button>
                <form action="{{ route('taxi.complete.with.rating') }}" method="POST" onsubmit="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© ÙˆØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø³Ø§Ø¦Ù‚ØŸ')">
                    @csrf
                    <input type="hidden" name="order_id" value="{{ $order->id }}">
                    <input type="hidden" name="driver_id" value="{{ $driver->id }}">
                    <input type="hidden" name="driver_name" value="{{ $driver->name }}">
                    <input type="hidden" name="rating" value="5">
                    <input type="hidden" name="comment" value="Ø±Ø­Ù„Ø© Ù…Ù…ØªØ§Ø²Ø©">
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg shadow transition-all duration-200">âœ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>
                </form>
            </div>
        </div>

        {{-- âœ… Leaflet + Ø¥Ø´Ø¹Ø§Ø±Ø§Øª --}}
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        <style>
            .pulse { animation: pulse 1s infinite; }
            @keyframes pulse { 0%{transform:scale(1);opacity:1;}50%{transform:scale(1.3);opacity:0.6;}100%{transform:scale(1);opacity:1;} }
        </style>

        <script>
        // ======= Ø§Ù„Ø£ØµÙˆØ§Øª & Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© =======
        const arrivalSound = new Audio('/sounds/arrival.mp3');
        const messageSound = new Audio('/sounds/message.mp3');
        const statusChangeSound = new Audio('/sounds/status-change.mp3');

        const notifBanner = document.getElementById("notifBanner");
        const notifToggle = document.getElementById("notifToggle");
        const statusBar   = document.getElementById("statusBar");
        let notifEnabled  = false;
        let lastMessageCount = 0;

        let lastDriverStatus = @json($driver->status ?? '');
        let lastOrderStatus  = @json($order->status ?? '');
        let arrivalAnnounced = false;

        // ======= Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© =======
        function statusToText(s){
            if(!s) return 'â€”';
            if(s === 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°') return 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ! Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ø£Ù‚Ø±Ø¨ ÙÙŠ Ø·Ø±ÙŠÙ‚Ù‡ Ø¥Ù„ÙŠÙƒ.';
            if(s === 'Ø¨Ø¯Ø£Øª Ø§Ù„Ø±Ø­Ù„Ø©') return 'ğŸš– Ø§Ù„Ø±Ø­Ù„Ø© Ø¨Ø¯Ø£Øª! Ø§Ø³ØªÙ…ØªØ¹ Ø¨Ù…Ø´ÙˆØ§Ø±Ùƒ.';
            if(s === 'Ù…Ù†ØªÙ‡ÙŠ')       return 'âœ… Ø§Ù„Ø±Ø­Ù„Ø© Ù…Ù†ØªÙ‡ÙŠØ©.';
            if(s === 'Ù…Ù„ØºÙŠ')        return 'ğŸš« ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨.';
            return 'ğŸš§ Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨: ' + s;
        }

        function colorForStatus(s){
            if(s === 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°' || s?.includes('Ø¨Ø§Ù†ØªØ¸Ø§Ø±') || s?.includes('ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚')) return 'bg-yellow-500';
            if(s === 'Ø¨Ø¯Ø£Øª Ø§Ù„Ø±Ø­Ù„Ø©') return 'bg-blue-600';
            if(s === 'Ù…Ù†ØªÙ‡ÙŠ')       return 'bg-green-600';
            if(s === 'Ù…Ù„ØºÙŠ')        return 'bg-gray-600';
            return 'bg-indigo-600';
        }

        function updateStatusBarDisplay(status){
            statusBar.textContent = 'ğŸš¦ ' + (status || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ');
            statusBar.className = `w-full text-center py-3 font-bold text-white transition-colors duration-500 ${colorForStatus(status)}`;
        }

        function pushNotification(title, body){
            if(!notifEnabled) return;
            try{
                if(Notification.permission === "granted"){
                    new Notification(title, { body, icon: "/images/taxi-icon.png" });
                }
            }catch(_){}
        }

        function onDriverArrived(){
            if(!arrivalAnnounced){
                arrivalAnnounced = true;
                pushNotification("ğŸš– Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØµÙ„", "Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ø¢Ù† ÙÙŠ Ù…ÙˆÙ‚Ø¹Ùƒ ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§.");
                try{ arrivalSound.play(); }catch(_){}
                document.getElementById('eta').textContent = "ğŸš– Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØµÙ„!";
            }
        }

        function onStatusChanged(newStatus){
            if(newStatus && newStatus !== lastOrderStatus){
                pushNotification("ğŸ”” ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø­Ù„Ø©", "Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: " + newStatus);
                try{ statusChangeSound.play(); }catch(_){}
                lastOrderStatus = newStatus;
                updateStatusBarDisplay(newStatus);
                document.getElementById('statusText').textContent = statusToText(newStatus);
            }
        }

        function updateNotifBanner(){
            notifBanner.classList.remove("hidden");
            notifBanner.textContent = notifEnabled ? "âœ… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…ÙØ¹Ù„Ø©" : "âŒ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ø¹Ø·Ù„Ø©";
            notifBanner.className = notifEnabled
                ? "w-full text-center py-2 font-semibold bg-green-500 text-white"
                : "w-full text-center py-2 font-semibold bg-red-500 text-white";
        }

        function kmDistance(aLat,aLng,bLat,bLng){
            const R=6371, dLat=(bLat-aLat)*Math.PI/180, dLng=(bLng-aLng)*Math.PI/180;
            const s1=Math.sin(dLat/2), s2=Math.sin(dLng/2);
            const A=s1*s1 + Math.cos(aLat*Math.PI/180)*Math.cos(bLat*Math.PI/180)*s2*s2;
            return R * (2 * Math.atan2(Math.sqrt(A), Math.sqrt(1-A)));
        }

        // ======= Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± =======
        const driverInitial = {
            lat: parseFloat("{{ $driver->latitude }}"),
            lng: parseFloat("{{ $driver->longitude }}"),
            name: @json($driver->name),
            car:  @json($driver->car_number),
            phone:@json($driver->phone),
            status:@json($driver->status),
        };

        const user = {
            lat: parseFloat("{{ $order->pickup_latitude }}"),
            lng: parseFloat("{{ $order->pickup_longitude }}")
        };

        // ======= Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø±Ø§ÙƒØ¨ (Ø§Ù„Ù…ØµØºØ±Ø©) =======
        document.addEventListener("DOMContentLoaded", function () {
            const pickupMap = L.map('pickup-map').setView([user.lat, user.lng], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: 'Â© OpenStreetMap' }).addTo(pickupMap);
            L.marker([user.lat, user.lng]).addTo(pickupMap).bindPopup("ğŸ“ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø±Ø§ÙƒØ¨ (Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚)").openPopup();
        });

        // ======= Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„ÙƒØ¨ÙŠØ±Ø© (Ø§Ù„Ø³Ø§Ø¦Ù‚ â†”ï¸ Ø§Ù„Ø±Ø§ÙƒØ¨) =======
        const map = L.map('map').setView([user.lat, user.lng], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(map);
        const taxiIcon = L.icon({ iconUrl: '/images/taxi-icon.png', iconSize: [36,36], iconAnchor:[18,36] });

        const driverMarker = L.marker([driverInitial.lat, driverInitial.lng], { icon: taxiIcon })
            .addTo(map).bindPopup("ğŸš• Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù‡Ù†Ø§").openPopup();

        const userMarker = L.circleMarker([user.lat, user.lng], {
            radius:8, fillColor:"#007BFF", color:"#fff", weight:2, fillOpacity:0.9
        }).addTo(map).bindPopup("ğŸ“ Ù…ÙˆÙ‚Ø¹Ùƒ").openPopup();

        let pathLine = L.polyline([[driverInitial.lat, driverInitial.lng],[user.lat,user.lng]], { color:'blue' }).addTo(map);

        // ======= Ø£Ø²Ø±Ø§Ø±/Ø£Ø­Ø¯Ø§Ø« Ø¹Ø§Ù…Ø© =======
        document.getElementById("contactDriverBtn").addEventListener("click", () => {
            const ph = document.getElementById('dPhone')?.getAttribute('href') || '';
            if (ph) location.href = ph; else alert("ğŸ“ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± Ù…ØªÙˆÙØ±.");
        });

        function cancelOrder(){
            if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ØŸ")) window.location.href = "{{ route('home') }}";
        }
        window.cancelOrder = cancelOrder; // Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù…ØªØ§Ø­Ø© Ù„Ù„Ø²Ø±

        // ======= ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª =======
        document.addEventListener('DOMContentLoaded', async () => {
            const saved = localStorage.getItem('taxi_push_notif') === '1';
            notifEnabled = saved && (("Notification" in window) ? (Notification.permission === 'granted') : false);
            if (notifToggle) notifToggle.checked = notifEnabled;
            updateNotifBanner();
            updateStatusBarDisplay(@json($order->status ?? ''));

            notifToggle?.addEventListener('change', async () => {
                if (!("Notification" in window)) { alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª.'); notifToggle.checked = false; return; }
                if (notifToggle.checked) {
                    const perm = await Notification.requestPermission();
                    if (perm !== 'granted') {
                        notifToggle.checked = false;
                        notifEnabled = false;
                        localStorage.setItem('taxi_push_notif','0');
                        updateNotifBanner();
                        return;
                    }
                    notifEnabled = true;
                    localStorage.setItem('taxi_push_notif','1');
                } else {
                    notifEnabled = false;
                    localStorage.setItem('taxi_push_notif','0');
                }
                updateNotifBanner();
            });
        });

        // ======= Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­ÙŠ (Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ + Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚) =======
        async function refreshLive(){
            try{
                const res = await fetch("{{ route('taxi.order.json', $order->id) }}", { cache: 'no-store' });
                if(!res.ok) return;
                const { order, driver } = await res.json();

                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();

                // Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ + Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø©
                if(order?.status){
                    onStatusChanged(order.status);
                }

                // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø©
                if(driver){
                    // Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ù‡Ø§ØªÙ
                    if (driver.name)  document.getElementById('dName').textContent = driver.name;
                    if (driver.phone){
                        const ph = document.getElementById('dPhone');
                        ph.href = 'tel:' + driver.phone;
                        ph.textContent = driver.phone;
                    }
                    if (driver.status){
                        document.getElementById('dStatus').textContent = driver.status;
                        if (driver.status !== lastDriverStatus){
                            lastDriverStatus = driver.status;
                        }
                    }
                    // Ø§Ù„Ø³ÙŠØ§Ø±Ø© (Ù‚Ø¯ Ù„Ø§ ØªØ£ØªÙŠ Ù…Ù† JSONØŒ ÙÙ†Ø¨Ù‚ÙŠÙ‡Ø§ ÙƒÙ…Ø§ Ù‡ÙŠ Ø¥Ù† Ù„Ù… ØªØªÙˆÙØ±)
                    if (driver.car_number){
                        document.getElementById('dCar').textContent = driver.car_number;
                    }

                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø±ÙŠØ·Ø©/ETA
                    const dLat = parseFloat(driver.latitude);
                    const dLng = parseFloat(driver.longitude);
                    if (Number.isFinite(dLat) && Number.isFinite(dLng)){
                        driverMarker.setLatLng([dLat, dLng]);
                        pathLine.setLatLngs([[dLat, dLng], [user.lat, user.lng]]);

                        const km = kmDistance(dLat, dLng, user.lat, user.lng);
                        // Ø³Ø±Ø¹Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© 40 ÙƒÙ…/Ø³
                        const minutes = Math.floor((km / 40) * 60);
                        const seconds = Math.round(((km / 40) * 60 - minutes) * 60);
                        document.getElementById('eta').textContent =
                            km < 0.05 ? "ğŸš– Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØµÙ„!" : `${minutes} Ø¯Ù‚ÙŠÙ‚Ø© ${seconds} Ø«Ø§Ù†ÙŠØ© (${km.toFixed(2)} ÙƒÙ…)`;

                        if (km < 0.05) onDriverArrived();
                    }
                }
            }catch(_){}
        }
        refreshLive();
        setInterval(refreshLive, 10000);

        // ======= Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© =======
        async function loadMessages(){
            const orderId = "{{ $order->id }}";
            const res = await fetch("{{ route('driver.message.fetch') }}?order_id=" + orderId);
            if(!res.ok) return;
            const messages = await res.json();
            const chatBox = document.getElementById("chatBox");

            if (messages.length > lastMessageCount) {
                try{ messageSound.play(); }catch(_){}
                lastMessageCount = messages.length;
            }

            chatBox.innerHTML = "";
            messages.forEach(msg => {
                const msgDiv = document.createElement("div");
                const date = new Date(msg.created_at);
                const formattedTime = date.toLocaleTimeString('ar-EG',{hour:'2-digit',minute:'2-digit'});
                if (msg.sender === 'user') {
                    msgDiv.className = "bg-yellow-100 text-gray-800 p-2 rounded-lg text-right w-fit ml-auto max-w-[80%]";
                    msgDiv.innerHTML = `<strong>ğŸ‘¤ Ø£Ù†Øª:</strong> ${msg.message}<br><small class="text-gray-500">${formattedTime}</small>`;
                } else {
                    msgDiv.className = "bg-gray-200 text-gray-800 p-2 rounded-lg text-right w-fit mr-auto max-w-[80%]";
                    msgDiv.innerHTML = `<strong>ğŸš• Ø§Ù„Ø³Ø§Ø¦Ù‚:</strong> ${msg.message}<br><small class="text-gray-500">${formattedTime}</small>`;
                }
                chatBox.appendChild(msgDiv);
            });
            chatBox.scrollTop = chatBox.scrollHeight;
        }
        document.getElementById("chatForm").addEventListener("submit", async function(e){
            e.preventDefault();
            const formData = new FormData(this);
            await fetch("{{ route('driver.message.store') }}", { method: "POST", body: formData });
            this.reset();
            loadMessages();
        });
        setInterval(loadMessages, 5000);
        loadMessages();
        </script>
    </div>
</x-main-layout>
