<?php

use App\Http\Controllers\TaxiFareController;
use Illuminate\Support\Facades\Route;
use App\Http\Controllers\{
    HomeController, ContactController, MessageController,
    AdController, ReportController, FavoriteController,
    DashboardController, ProfileController,
    EmergencyServiceController, EmergencyReportController,
    DriverController, TaxiDriverController,
    OrderController, RatingController, TaxiController,
    TaxiMapController, TaxiMessageController, TaxiChatController,
    MapController, UserController, AdminController,
    Dashboard\StatisticsController,
    Admin\DashboardController as AdminDashboard,
    Admin\EmergencyReportController as AdminEmergencyReportController,
    AdminEmergencyController,
    SupportTicketController,
    TaxiOrderController,
    Admin\SupportTicketAdminController,
    EmergencyStatisticsController
};

// âœ… Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
Route::get('/', [AdController::class, 'index'])->name('home');

// âœ… Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ©
Route::view('/about', 'about')->name('about');
Route::view('/privacy', 'pages.privacy')->name('privacy');
Route::view('/terms', 'pages.terms')->name('terms');
Route::view('/faq', 'pages.faq')->name('faq');
Route::get('/contact', [ContactController::class, 'show'])->name('contact');
Route::post('/contact', [ContactController::class, 'send'])->name('contact.send');

// âœ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠ Ù„Ù„ØªØ§ÙƒØ³ÙŠ
Route::post('/taxi/calculate-fare', [TaxiFareController::class, 'calculate'])
    ->name('taxi.calculateFare');

Route::get('/delni-taxi-en', function () {
    return view('taxi.landing-en');
})->name('taxi.english');

// âœ… ØµÙØ­Ø© ØªØ¹Ø±ÙŠÙ Ø¯Ù„Ù†ÙŠ ØªÙƒØ³ÙŠ
Route::view('/taxi-info', 'taxi.landing')->name('taxi.info');

// âœ… Ù…ØµØ§Ø¯Ù‚Ø©
require __DIR__.'/auth.php';

// âœ… Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ - ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
Route::put('/dashboard/update-password', [DashboardController::class, 'updatePassword'])->name('dashboard.updatepassword');
Route::prefix('dashboard')->middleware(['auth'])->group(function () {
    Route::get('/edit-password', [DashboardController::class, 'editPassword'])->name('dashboard.editpassword');
});

// âœ… ØªØ¹Ø¯Ø¯ Ø§Ù„Ù„ØºØ§Øª
Route::get('/lang/{locale}', function ($locale) {
    if (in_array($locale, ['ar', 'en'])) {
        session()->put('locale', $locale);
        app()->setLocale($locale);
    }
    return redirect()->back();
})->name('lang.switch');
Route::get('change-language/{lang}', fn($lang) => session()->put('locale', $lang))->name('change-language');

// âœ… Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª
Route::prefix('ads')->group(function () {
    Route::get('/', [AdController::class, 'index'])->name('ads.index');
    Route::get('/{id}', [AdController::class, 'show'])->name('ads.show');
    Route::post('/{id}/favorite', [AdController::class, 'addFavorite'])->name('ads.favorite');
    Route::delete('/{id}/unfavorite', [AdController::class, 'removeFavorite'])->name('ads.unfavorite');
    Route::post('/{id}/report', [ReportController::class, 'store'])->middleware('auth')->name('ads.report');
    Route::get('/featured', [AdController::class, 'featured'])->name('ads.featured');
    Route::post('/favorites/{ad}', [FavoriteController::class, 'store'])->name('favorites.store');
});

// âœ… Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦
Route::prefix('emergency-services')->group(function () {
    Route::get('/', [EmergencyServiceController::class, 'index'])->name('emergency.index');
    Route::get('/create', [EmergencyServiceController::class, 'create'])->name('emergency_services.create');
    Route::post('/', [EmergencyServiceController::class, 'store'])->name('emergency_services.store');
    Route::get('/{id}', [EmergencyServiceController::class, 'show'])->name('emergency_services.show');
    Route::get('/{id}/edit', [EmergencyServiceController::class, 'edit'])->name('emergency_services.edit');
    Route::put('/{id}', [EmergencyServiceController::class, 'update'])->name('emergency_services.update');
    Route::delete('/{id}', [EmergencyServiceController::class, 'destroy'])->name('emergency_services.destroy');
    Route::get('/map-data', [EmergencyServiceController::class, 'mapData'])->name('emergency_services.mapData');
});
Route::get('/emergency/statistics', [EmergencyStatisticsController::class, 'index'])->name('emergency.stats');
Route::post('/emergency-services', [EmergencyServiceController::class, 'store'])->name('emergency.store');

Route::middleware(['auth'])->prefix('emergency-reports')->group(function () {
    Route::get('/', [EmergencyReportController::class, 'index'])->name('emergency_reports.index');
    Route::get('/{id}', [EmergencyReportController::class, 'show'])->name('emergency_reports.show');
    Route::delete('/{id}', [EmergencyReportController::class, 'destroy'])->name('emergency_reports.destroy');
});
Route::post('/emergency-reports', [EmergencyReportController::class, 'store'])->name('emergency_reports.store');

// âœ… Ø®Ø¯Ù…Ø§Øª Delni Taxi
Route::get('/delni-taxi', [TaxiController::class, 'index'])->name('delni.taxi');
Route::post('/taxi/request', [OrderController::class, 'store'])->name('taxi.request');
Route::get('/order-status', [OrderController::class, 'status'])->name('order.status');
Route::get('/trip/completed', [TaxiController::class, 'tripCompleted'])->name('trip.completed');
Route::post('/submit-rating', [RatingController::class, 'store'])->name('submit.rating');
Route::post('/taxi/order/complete-with-rating', [TaxiOrderController::class, 'completeWithRating'])->name('taxi.complete.with.rating');
Route::get('/taxi/order/{id}/status', [TaxiOrderController::class, 'showStatus'])->name('taxi.order.status');

Route::post('/taxi/order/save-from-map', [TaxiOrderController::class, 'storeFromMap'])
    ->name('taxi.order.saveFromMap');

// âœ… ØµÙØ­Ø© Ø§Ù„Ø·Ù„Ø¨ (ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ LocalStorage) + ØµÙØ­Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø³Ø§Ø¦Ù‚ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
Route::view('/order-taxi', 'order-taxi')->name('order.taxi');
Route::get('/order-taxi/{driverId}', [TaxiController::class, 'showOrderPage'])->name('order.taxi.with.driver');

Route::view('/driver/login', 'taxi.drivers.login')->name('driver.login');
Route::view('/driver/dashboard', 'taxi.drivers.panel');
Route::view('/services', 'services.index')->name('services');
Route::get('/taxi', [TaxiController::class, 'landing'])->name('taxi.landing');

// =====================
// ğŸš– Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø·Ù„Ø¨ (Ø¹Ø§Ù…)
// =====================
Route::get('/taxi/order-map', function () {
    $request = request();
    $startStr = $request->query('start', '36.2021,37.1343');
    $endStr   = $request->query('end',   '36.2155,37.1590');

    [$sLat, $sLng] = array_map('floatval', explode(',', $startStr));
    [$eLat, $eLng] = array_map('floatval', explode(',', $endStr));

    $start = ['lat' => $sLat, 'lng' => $sLng, 'label' => $request->query('start_label', 'Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚')];
    $end   = ['lat' => $eLat, 'lng' => $eLng, 'label' => $request->query('end_label', 'Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆØµÙˆÙ„')];

    return view('taxi.order-map', compact('start', 'end'));
})->name('taxi.order.map');

// ØµÙØ­Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨
Route::get('/taxi/order/{id}/status', [\App\Http\Controllers\TaxiOrderController::class, 'showStatus'])
    ->name('taxi.order.status');

// Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ ÙƒÙ€ JSON (Ù„Ù„Ø¨ÙˆÙ„Ù†Øº)
Route::get('/taxi/order/{id}/json', function ($id) {
    $order  = \App\Models\TaxiOrder::findOrFail($id);
    $driver = \App\Models\Driver::find($order->driver_id);
    return response()->json([
        'order'  => $order,
        'driver' => $driver ? $driver->only(['id','name','phone','status','latitude','longitude']) : null,
    ]);
})->name('taxi.order.json');

// âœ… Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„ØªØ§ÙƒØ³ÙŠ
Route::post('/driver/message', [TaxiMessageController::class, 'store'])->name('driver.message.store');
Route::get('/driver/messages', [TaxiMessageController::class, 'fetch'])->name('driver.message.fetch');
Route::get('/chat/{order}', [TaxiMessageController::class, 'driverChat'])->name('driver.chat');
Route::post('/chat/{order}', [TaxiMessageController::class, 'driverReply'])->name('driver.message.reply');
Route::get('/taxi/chat/{order_id}', [TaxiChatController::class, 'showPassengerChat'])->name('passenger.chat');

// âœ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†
Route::prefix('drivers')->middleware(['auth'])->group(function () {
    Route::get('/', [DriverController::class, 'index'])->name('drivers.index');
    Route::get('/create', [DriverController::class, 'create'])->name('drivers.create');
    Route::post('/store', [DriverController::class, 'store'])->name('drivers.store');
    Route::get('/{id}/edit', [DriverController::class, 'edit'])->name('drivers.edit');
    Route::put('/{id}', [DriverController::class, 'update'])->name('drivers.update');
    Route::post('/{id}/status', [DriverController::class, 'updateStatus'])->name('drivers.updateStatus');
    Route::delete('/{id}', [DriverController::class, 'destroy'])->name('drivers.destroy');
    Route::get('/{id}', [DriverController::class, 'show'])->name('drivers.show');
});
Route::get('/drivers/map', [TaxiMapController::class, 'index'])->name('drivers.map');
Route::get('/driver/register', [DriverController::class, 'showRegisterForm'])->name('driver.register');
Route::post('/driver/register', [DriverController::class, 'register'])->name('driver.register.submit');

// âœ… Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø³Ø§Ø¦Ù‚
Route::middleware(['auth', 'driver'])->group(function () {
    Route::get('/driver/dashboard', [DriverController::class, 'dashboard'])->name('driver.dashboard');
});

// âœ… Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
Route::middleware(['auth'])->prefix('dashboard')->group(function () {
    Route::get('/', [DashboardController::class, 'index'])->name('dashboard.index');
    Route::get('/myinfo', [DashboardController::class, 'myInfo'])->name('dashboard.myinfo');
    Route::get('/myinfo/edit', [DashboardController::class, 'editInfo'])->name('dashboard.myinfo.edit');
    Route::post('/myinfo/update', [DashboardController::class, 'updateInfo'])->name('dashboard.myinfo.update');
    Route::get('/myads', [AdController::class, 'myAds'])->name('dashboard.myads');
    Route::get('/ads/create', [AdController::class, 'create'])->name('dashboard.ads.create');
    Route::post('/ads/store', [AdController::class, 'store'])->name('dashboard.ads.store');
    Route::get('/ads/{id}/edit', [AdController::class, 'edit'])->name('dashboard.ads.edit');
    Route::post('/ads/{id}', [AdController::class, 'update'])->name('dashboard.ads.update');
    Route::delete('/ads/{id}', [AdController::class, 'destroy'])->name('dashboard.ads.destroy');
    Route::post('/ads/{id}/feature', [AdController::class, 'feature'])->name('ads.feature');
    Route::post('/ads/{id}/unfeature', [AdController::class, 'unfeature'])->name('ads.unfeature');
    Route::get('/account/settings', [DashboardController::class, 'accountSettings'])->name('dashboard.settings');
    Route::post('/account/settings/update', [DashboardController::class, 'updateAccountSettings'])->name('dashboard.settings.update');
    Route::get('/password/change', [DashboardController::class, 'changePassword'])->name('dashboard.password.change');
    Route::post('/password/update', [DashboardController::class, 'updatePassword'])->name('dashboard.password.update');
    Route::get('/myorders', [DashboardController::class, 'myOrders'])->name('dashboard.myorders');
    Route::get('/support', [SupportTicketController::class, 'index'])->name('support.index');
    Route::get('/support/create', [SupportTicketController::class, 'create'])->name('support.create');
    Route::post('/support', [SupportTicketController::class, 'store'])->name('support.store');
    Route::get('/support/{id}', [SupportTicketController::class, 'show'])->name('support.show');
    Route::get('/favorites', [FavoriteController::class, 'index'])->name('favorites.index');
    Route::delete('/favorites/{id}', [FavoriteController::class, 'destroy'])->name('favorites.destroy');
});

// ğŸš– (Ø¹Ø§Ù…) Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ ØªØ§ÙƒØ³ÙŠ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
Route::get('/taxi-orders/create', [TaxiOrderController::class, 'create'])
    ->name('taxi.orders.create.public');
Route::post('/taxi-orders', [TaxiOrderController::class, 'store'])
    ->name('taxi.orders.store.public');
Route::get('/taxi/order-status/{id}', [TaxiOrderController::class, 'orderStatus'])->name('taxi.order.status');

// âœ… Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø´Ø±Ù
Route::prefix('admin')->middleware(['auth', 'admin'])->group(function () {
    Route::get('/', [AdminDashboard::class, 'index'])->name('admin.dashboard');
    Route::get('/statistics', [StatisticsController::class, 'index'])->name('dashboard.statistics');
    Route::get('/taxi-orders', [TaxiOrderController::class, 'index'])->name('admin.taxi.orders');
    Route::get('/dashboard/favorites', fn () => view('dashboard.favorites'))->name('dashboard.favorites');
    Route::get('/notifications', [AdminController::class, 'notifications'])->name('admin.notifications');
    Route::get('/support-tickets', [SupportTicketAdminController::class, 'index'])->name('admin.support_tickets.index');
    Route::get('/support-tickets/statistics', [SupportTicketAdminController::class, 'statistics'])->name('admin.support_tickets.statistics');
    Route::get('/support-tickets/{id}', [SupportTicketAdminController::class, 'show'])->name('admin.support_tickets.show');
    Route::put('/support-tickets/{id}', [SupportTicketAdminController::class, 'update'])->name('admin.support_tickets.update');
    Route::get('/emergency-dashboard', [EmergencyReportController::class, 'dashboard'])->name('admin.emergency_dashboard');
    Route::get('/emergency-reports', [AdminEmergencyReportController::class, 'index'])->name('admin.reports.index');
    Route::get('/emergency-reports/{id}', [AdminEmergencyReportController::class, 'show'])->name('admin.emergency_reports.show');
    Route::post('/emergency-reports/{id}/update-status', [AdminEmergencyReportController::class, 'updateStatus'])->name('admin.emergency_reports.update_status');
    Route::delete('/emergency-reports/{id}', [AdminEmergencyReportController::class, 'destroy'])->name('admin.emergency_reports.destroy');
    Route::get('/emergency-services', [EmergencyServiceController::class, 'index'])->name('emergency_services.index');
    Route::get('/emergency-centers', [AdminEmergencyController::class, 'index'])->name('admin.emergency_centers.index');
    Route::get('/users', [UserController::class, 'index'])->name('admin.users.index');
    Route::post('/users/{id}/promote', [UserController::class, 'promote'])->name('admin.users.promote');

    // ğŸš– Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ ØªØ§ÙƒØ³ÙŠ Ø¬Ø¯ÙŠØ¯ Ø¯Ø§Ø®Ù„ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±Ù
    Route::get('/taxi-orders/create', [TaxiOrderController::class, 'create'])->name('taxi.orders.create');
    Route::post('/taxi-orders', [TaxiOrderController::class, 'store'])->name('taxi.orders.store');

    // âœ… Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ù„Ù„Ù…Ø´Ø±Ù
    Route::get('/emergency/statistics', [EmergencyStatisticsController::class, 'index'])->name('admin.emergency.stats');
});
